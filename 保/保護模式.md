{{noteTA
|G1=IT
|1=zh-hans:任务;zh-hant:工作;
|4=zh-hans:运行模式;zh-hant:操作模式;
}}
'''保護模式'''（{{lang-en|Protected Mode}}，或有時簡寫為 pmode）是一種[[80286|80286]]系列和之後的[[x86|x86]]兼容[[CPU|CPU]]的操作模式。保護模式有一些新的特性，如[[記憶體保護|記憶體保護]]，[[分頁|分頁]]系統以及硬體支援的[[虛擬記憶體|虛擬記憶體]]，能夠增強[[多任务处理|多任务处理]]和系統穩定度。現今大部分的x86[[作業系統|作業系統]]都在保護模式下運行，包含[[Linux|Linux]]、[[FreeBSD|FreeBSD]]、以及[[微軟|微軟]][[Windows_2.0|Windows 2.0]]和之後版本。

另外一種286和其之後CPU的操作模式是[[真實模式|真實模式]]，這是一種[[向前相容|向前相容]]且關閉了保护模式這些特性的CPU运行模式，用來讓新的晶片可以執行舊的軟體。所有的x86 CPU都是在真實模式下開機，來確保傳統作業系統的相容性。為了使用保護模式的特性，要由程式主動地切換到保護模式。在現今的電腦上，這種切換通常是[[作業系統|作業系統]]在開機時候完成的第一件工作。當CPU在保護模式下運行時，可以使用[[虚拟86模式|虚拟86模式]]來執行為真實模式設計的程式碼。

儘管用軟體的方式也有某些可能在真實模式的系統下使用多工，但保護模式下記憶體保護的特色，可以避免有問題的程式破壞其他工作或是[[作業系統|作業系統]]核心所擁有的記憶體。保護模式也有中斷正在執行程式的硬體支援，可以實現[[先佔式多工|先佔式多工]]。

大部分可以使用保護模式的CPU也擁有32位元[[暫存器|暫存器]]的特性（例如[[80386|80386]]系列和其後任何的晶片），導入了融合保護模式而成為32位元處理的概念。[[80286|80286]]晶片雖有支援保護模式，但是仍然只有16位元暫存器。[[Windows_2.0|Windows 2.0]]和之後版本中的保護模式增強稱為"386增強模式"，是因為他們除了保護模式外，還需要32位元的暫存器，並且無法在286上面執行（即使286支援保護模式）。

即使在32位元晶片上已經打開了保護模式，但是為了仿照IBM XT系統記憶體連續的設計特性，1 MiB以上的記憶體並無法存取。這種限制可以由打開[[A20总线|A20总线]]來迴避。

在保護模式下，前面32個[[中斷|中斷]]都是保留給CPU[[例外處理|例外處理]]用。例如，中斷0D（十進制13）是一般保護模式錯誤，而中斷00是[[除以零|除以零]]。

== 286的保护模式寻址 ==
[[Image:080810-protected-286-segments.PNG|thumb]]
286出现之前，x86的地址总线为20位，使用16位的段基址（段首地址的高16位）与16位的段内偏移量，段基址左移4位后与段内偏移量相加形成20位的[[物理地址|物理地址]]，来对2<sup>''20''</sup>（即1MiB）的[[地址空间|地址空间]][[寻址|寻址]]。1982年问世的286 CPU首次使用了保护模式寻址。286 CPU的[[地址总线|地址总线]]为24位，寻址空间为2<sup>''24''</sup>（即16 MiB）。而286 CPU的寄存器仍为16位。寻址时，段寄存器保存的数据不再是内存物理地址，而是称作选择器（selector），其中高13位指向描述符表（descriptor table）的条目；最低的两位数据定义了请求的权限，从0到3，0是最高权限，3是最低权限；剩下的一位表示是使用{{tsl|en|Global Descriptor Table|全局描述符表}}（GDT）还是{{tsl|en|Local Descriptor Table|局部描述符表}}（LDT）。描述符表的条目为8字节长，包括24位长的段起始物理地址、16位长的段长（因此段的长度范围从1 B到2<sup>''16''</sup> B，即不超过64 KiB）。每次内存操作所要访问的物理地址为描述符表相应条目给出的24位段起始物理地址再加上16位的[[偏移量|偏移量]]。可见，286保护模式下的应用程序能访问的内存线性地址空间仅为64 KB，非常有限。所以程序员编写使用大内存的应用程序时还必须使用远[[指標_(電腦科學)|指针]]、近指针，相当繁琐。这影响了286保护模式的推广使用。

== 从386开始的IA32保护模式寻址==
[[Image:080810-protected-386-paging.svg|thumb]]
[[Image:X86_Paging_4M.svg|thumb]]
[[Image:Virtual_address_space_and_physical_address_space_relationship.svg|thumb]]

1985年问世的80386开启了32位CPU时代。[[地址总线|地址总线]]为32比特，[[寻址空间|寻址空间]]为2<sup>''32''</sup>（即4 GiB）。386 CPU保护模式下有两种内存寻址方式：
*可以分页寻址，这是此后的x86上的Windows操作系统与Linux操作系统最广泛采用的方法；
*也可以非分页寻址而采取与286保护模式兼容的寻址方式，采用32位的选择器（selector）寄存器与32位的偏移量寄存器寻址，这时描述符表的条目中保存的段起始物理地址为32位，而段长的数据宽度为20位，但可以设置段长的粒度为1 B或4 KiB，所以段的最大长度可以是1 MiB或者4 GiB。

386 CPU开创的分页内存管理，比286保护模式寻址具有更多的优点：
* 操作系统可以控制与限制进程对页面的访问权限
* 为应用程序创造一个连续的、独立的、线性的虚拟内存空间
* 页面可以移出[[主存|主存]]，存入更慢速的次级[[外存储器|外存]]如[[硬盘|硬盘]]。这使得操作系统可以使用比物理内存更大的存储空间。

IA32的CPU通过两级：页目（page directory）与[[页表|页表]]（page table）实现4 KiB的分页管理，这是最常见的IA32分页寻址方式。CR3寄存器保存了进程的页目的物理地址。页目与页表中每4字节为一个单元，是一个32位的值，当页目项第0位为1时，表明页表已经在物理内存中；当页表项第0位为1时，表明访问的数据已经在内存中。另外，当页目项第7位为1时，表明这是一个4M的页面，这值已经是物理页地址，用虚拟地址的低22位作为偏移量。

从应用程序角度，不再使用段地址寄存器（或称选择器），仅使用32位的偏移量，为2<sup>''32''</sup>（即4 GiB）的连续线性寻址空间。

== 参见 ==
* [[x86|x86]]
* [[真實模式|真實模式]]
* [[系统管理模式|系统管理模式]]
* [[长模式|长模式]]

== 外部連結 ==

* https://web.archive.org/web/20050616001715/http://x86.ddj.com/articles/pmbasics/tspec_a1_doc.htm
{{操作系统}}

[[Category:X86架構|Category:X86架構]]